# ğŸš€ Multi-Tenant SaaS Platform - Production-Ready Architecture

**Stack:** NestJS 11 + Prisma 7 + PostgreSQL 16 + Redis 7 + BullMQ + Docker

## ğŸ“‹ Project Overview

Enterprise-grade Multi-Tenant SaaS backend designed for B2B platforms (CRM, Analytics, Internal Tools). This project implements industry-standard patterns for authentication, authorization, multi-tenancy, background jobs, and scalability.

## ğŸ—ï¸ Architecture

```
Client (Web / Mobile)
        â†“
   API Gateway
        â†“
   NestJS Backend
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Modules Layer        â”‚
â”‚  (Auth, Users, etc.)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Infrastructure Layer  â”‚
â”‚ Prisma | Redis | S3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    PostgreSQL

```

## âœ¨ Core Features

### ğŸ” Authentication & Security

- JWT Access Tokens (15 min expiry)
- Refresh Token rotation with HttpOnly cookies
- Token reuse detection (SHA-256 hashing)
- Account lockout after failed login attempts
- Device-based session tracking
- Redis-based logout invalidation

### ğŸ‘¥ Authorization (RBAC)

- Role hierarchy (USER, ADMIN, SUPER_ADMIN)
- Permission-level access control
- Guards + decorators (`@Roles('ADMIN')`, `@Permissions('users.create')`)
- Per-tenant role isolation

### ğŸ¢ Multi-Tenancy

- Row-level `tenant_id` isolation
- Prisma middleware for automatic tenant scoping
- Request-scoped tenant context
- Zero cross-tenant data leakage

### ğŸ“¦ Background Jobs (BullMQ)

- Redis-backed job queues
- Email processing
- Webhook delivery with retry logic
- Audit log batching
- File processing pipelines

### â˜ï¸ File Uploads

- S3 / MinIO integration
- Pre-signed upload URLs
- Public & private file storage
- Metadata tracking in database

### ğŸ“Š Observability

- Structured logging (Pino/Winston)
- Request correlation IDs
- Health checks (DB + Redis)
- Job monitoring & metrics

## ğŸ“ Project Structure

## ğŸ“‚ Project Structure Deep Dive

```
backend/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ .env
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ nest-cli.json
â”‚
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ seed.ts
â”‚
â”œâ”€â”€ prisma.config.ts        # Prisma 7 config (NOT compiled by Nest)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts
â”‚   â”œâ”€â”€ app.module.ts
â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ app.config.ts
â”‚   â”‚   â”œâ”€â”€ database.config.ts
â”‚   â”‚   â”œâ”€â”€ redis.config.ts
â”‚   â”‚   â””â”€â”€ jwt.config.ts
â”‚
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ prisma.module.ts
â”‚   â”‚   â””â”€â”€ prisma.service.ts
â”‚
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login.dto.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ register.dto.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ jwt.strategy.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ refresh.strategy.ts
â”‚   â”‚   â”‚   â””â”€â”€ guards/
â”‚   â”‚   â”‚       â”œâ”€â”€ jwt-auth.guard.ts
â”‚   â”‚   â”‚       â””â”€â”€ refresh-auth.guard.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â”‚   â”œâ”€â”€ users.module.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ users.controller.ts
â”‚   â”‚   â”‚   â””â”€â”€ users.service.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ roles/
â”‚   â”‚   â”‚   â”œâ”€â”€ roles.guard.ts
â”‚   â”‚   â”‚   â””â”€â”€ roles.decorator.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ jobs/
â”‚   â”‚   â”‚   â”œâ”€â”€ jobs.module.ts
â”‚   â”‚   â”‚   â””â”€â”€ email.processor.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ health/
â”‚   â”‚       â”œâ”€â”€ health.controller.ts
â”‚   â”‚       â””â”€â”€ health.module.ts
â”‚
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ decorators/
â”‚       â”œâ”€â”€ guards/
â”‚       â”œâ”€â”€ interceptors/
â”‚       â”œâ”€â”€ filters/
â”‚       â””â”€â”€ utils/
â”‚
â””â”€â”€ dist/                  # generated by nest build
    â””â”€â”€ main.js

  

## ğŸ› ï¸ Tech Stack

| **Component** | **Version** | **Purpose** |
| --- | --- | --- |
| Node.js | 22.x | Runtime |
| NestJS | 11.x | Framework |
| TypeScript | 5.7.x | Language |
| Prisma | 7.x | ORM |
| PostgreSQL | 16 | Database |
| Redis | 7 | Cache + Queue |
| BullMQ | Latest | Job Queue |
| Docker | Latest | Containerization |

## ğŸš€ Quick Start

### 1. Prerequisites

```bash
node -v  # v22.x required
docker --version
docker-compose --version

```

### 2. Installation

```bash
# Clone repository
git clone <repository-url>
cd backend

# Install dependencies
npm install

# Copy environment variables
cp .env.example .env

# Start infrastructure (Postgres + Redis)
docker-compose up -d

# Run migrations
npx prisma migrate dev

# Seed database
npx prisma db seed

# Start development server
npm run start:dev

```

### 3. Verify Installation

```bash
# Health check
curl http://localhost:3000/health

# Expected response:
# { "status": "ok", "database": "connected", "redis": "connected" }

```

## ğŸ“š Database Schema

### Core Models

```
model Tenant {
  id        String   @id @default(uuid())
  name      String
  users     User[]
  createdAt DateTime @default(now())
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String
  role           Role      @default(USER)
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  createdAt      DateTime  @default(now())
}

model RefreshToken {
  id           String   @id @default(uuid())
  userId       String
  tokenHash    String   @unique
  expiresAt    DateTime
  isRevoked    Boolean  @default(false)
  userAgent    String?
  ipAddress    String?
  createdAt    DateTime @default(now())
}

model Permission {
  id     String @id @default(uuid())
  code   String @unique
  name   String
}

model Role {
  id          String @id @default(uuid())
  name        String
  tenantId    String
  permissions Json
}

```

## ğŸ”‘ Environment Variables

```bash
# Application
NODE_ENV=development
PORT=3000

# Database
DATABASE_URL="postgresql://user:password@localhost:5432/saas_db"

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT
JWT_SECRET=your-secret-key-change-this
JWT_ACCESS_EXPIRATION=15m
JWT_REFRESH_EXPIRATION=7d

# S3 / MinIO
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=uploads

# Email
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_USER=
SMTP_PASSWORD=

```

## ğŸ§ª Testing

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Test coverage
npm run test:cov

# Watch mode
npm run test:watch

```

## ğŸ“– API Documentation

### Authentication

```bash
# Register
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "tenantId": "uuid"
}

# Login
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

# Refresh Token
POST /auth/refresh
Cookie: refresh_token=...

# Logout
POST /auth/logout
Authorization: Bearer <access_token>

```

### Protected Routes

```bash
# Get current user
GET /users/me
Authorization: Bearer <access_token>

# List users (Admin only)
GET /users
Authorization: Bearer <access_token>
X-Tenant-ID: <tenant_id>

```

## ğŸ—“ï¸ Implementation Roadmap

### Phase 1: Foundation (Week 1-2)

- âœ… NestJS project setup with TypeScript
- âœ… Docker Compose (Postgres + Redis)
- âœ… Prisma schema design
- âœ… Environment configuration
- âœ… Health checks

### Phase 2: Authentication (Week 2-3)

- âœ… User registration with password hashing
- âœ… JWT access + refresh tokens
- âœ… Token rotation & reuse detection
- âœ… Account lockout mechanism
- âœ… Session management

### Phase 3: Authorization (Week 3-4)

- Role-based access control (RBAC)
- Permission system
- Guards & decorators
- Policy-based access

### Phase 4: Multi-Tenancy (Week 4-5)

- Tenant isolation via Prisma middleware
- Request-scoped tenant context
- Cross-tenant prevention tests

### Phase 5: Background Jobs (Week 5-6)

- BullMQ integration
- Email queue processor
- Webhook delivery system
- Job retry & dead letter queue

### Phase 6: File Management (Week 6)

- S3/MinIO integration
- Pre-signed URLs
- File metadata storage

### Phase 7: Observability (Week 7)

- Structured logging
- Request tracing
- Metrics & monitoring
- Error tracking

### Phase 8: Production Hardening (Week 8)

- Rate limiting
- Security headers
- Input validation & sanitization
- CI/CD pipeline
- Load testing

## ğŸ”’ Security Best Practices

- **HTTPS Everywhere:** Always use HTTPS in production
- **Secure Cookies:** HttpOnly, Secure, SameSite flags for refresh tokens
- **Rate Limiting:** Prevent brute force attacks (Redis-backed)
- **Input Validation:** class-validator on all DTOs
- **SQL Injection:** Prevented by Prisma's prepared statements
- **Token Security:** SHA-256 hashing for refresh tokens, bcrypt for passwords
- **Secrets Management:** Never commit .env files, use secret managers
- **Dependency Scanning:** Regular npm audit and updates

## ğŸš¢ Deployment

### Docker Production Build

```bash
# Build image
docker build -t saas-backend:latest .

# Run container
docker run -d \
  -p 3000:3000 \
  --env-file .env.production \
  saas-backend:latest

```

### CI/CD Pipeline (GitHub Actions)

```yaml
name: CI/CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        run: echo "Deploy step"

```

### Cloud Deployment Options

- **AWS:** ECS/Fargate + RDS + ElastiCache
- **GCP:** Cloud Run + Cloud SQL + Memorystore
- **DigitalOcean:** App Platform + Managed Database
- **Kubernetes:** Horizontal autoscaling with managed Postgres/Redis

## ğŸ“ˆ Performance Optimization

- **Database Indexing:** Proper indexes on frequently queried fields
- **Connection Pooling:** Prisma connection pool configuration
- **Redis Caching:** Cache frequently accessed data
- **Horizontal Scaling:** Stateless API design for load balancing
- **Queue Workers:** Separate worker processes for background jobs

## ğŸ¤ Contributing

Contributions are welcome! Please follow these guidelines:

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## ğŸ“ License

This project is licensed under the MIT License.

## ğŸ™ Acknowledgments

- NestJS framework for the solid foundation
- Prisma for the excellent ORM experience
- Community contributors and maintainers


## ğŸš€ Initial Setup Commands

### NVM Installation (if needed)

```bash
curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# After installation
nvm install 22
nvm use 22
nvm alias default 22

```

### Core Dependencies

```bash
# NestJS CLI
npm i -g @nestjs/cli

# Core packages
npm install @nestjs/config @nestjs/jwt @nestjs/passport passport passport-jwt
npm install prisma @prisma/client
npm install ioredis bullmq
npm install class-validator class-transformer

# Prisma 7 adapter
npm install @prisma/adapter-pg pg
npm install -D @types/pg

# Environment & validation
npm install zod
npm install --save-dev dotenv-cli

# Authentication & security
npm install bcrypt cookie-parser
npm install -D @types/bcrypt @types/cookie-parser

# Testing
npm install dotenv --save-dev

```

### Project Structure Setup

```bash
# Create directories
mkdir -p src/config
mkdir -p src/prisma
mkdir -p src/modules/{auth,users,roles,jobs,health}
mkdir -p src/common/{decorators,guards,interceptors,filters,utils}
mkdir -p prisma/migrations
mkdir -p src/modules/auth/{dto,strategies,guards,types}
mkdir -p src/modules/audit

# Create files
touch prisma/seed.ts
touch prisma/schema.prisma
touch prisma.config.ts
touch src/prisma/prisma.module.ts
touch src/prisma/prisma.service.ts
touch src/modules/health/health.module.ts
touch src/modules/health/health.controller.ts
touch src/config/app.config.ts
touch src/modules/auth/guards/refresh-auth.guard.ts
touch src/modules/auth/strategies/refresh.strategy.ts
touch src/modules/auth/types/jwt-payload.type.ts
touch src/modules/auth/types/role.enum.ts
touch src/modules/audit/audit.service.ts

# Testing files
touch test/auth.lockout.e2e-spec.ts
touch test/auth.refresh-reuse.e2e-spec.ts
touch test/rbac.e2e-spec.ts
touch test/setup.ts
touch test/utils/clear-db.ts

```

## ğŸ”’ Locked Tech Versions

| **Component** | **Version** |
| --- | --- |
| Node | v22.22.0 |
| NestJS | 11.1.12 |
| Prisma | 7.3.0 |
| PostgreSQL | 16.11 (Debian 16.11-1.pgdg13+1) |
| Redis | 7.4.7 sha=00000000:0 malloc=jemalloc-5.3.0 bits=64 build=c2f544f0759e4e85 |

## ğŸ› ï¸ Essential Commands Reference

### Version Checks

```bash
# Node.js version
node -v

# NestJS version
npm list @nestjs/core

# Nest CLI version
nest --version

# Prisma version
npx prisma -v

# PostgreSQL version
docker exec -it postgres_db psql --version

# Redis version
docker exec -it redis_cache redis-server --version

```

### Database Operations

```bash
# Generate Prisma client
npx prisma generate

# Run migrations
npx prisma migrate dev

# Named migration
npx prisma migrate dev --name add_refresh_token

# Migration with sudo (if needed)
sudo --preserve-env npx prisma migrate dev

# Deploy migrations (production)
npx dotenv -e .env.test -- npx prisma migrate deploy

# Create test database
docker exec -it postgres_db psql -U app_user -d app_db -c "CREATE DATABASE app_test_db;"

# Verify databases
docker exec -it postgres_db psql -U app_user -d app_db -l

```

### Docker Operations

```bash
# Build without cache
docker compose build --no-cache api

# Build and start
docker-compose up -d --build

# Stop containers
docker-compose down

# Clean up (volumes + orphans)
docker compose down --volumes --remove-orphans

# Remove image
docker rmi nest_api

# List running containers
docker ps

# List images
docker images

# Inspect container environment
docker exec -it nest_api env | grep DATABASE_URL
docker inspect nest_api --format='{{range .Config.Env}}{{println .}}{{end}}'

```

### Development Commands

```bash
# Build project
npm run build

# Clear Jest cache
npx jest --clearCache

# TypeScript server restart (VS Code)
# Cmd + Shift + P â†’ TypeScript: Restart TS Server

# Clean install (uses package-lock.json)
npm ci

```

## ğŸ“‹ Mandatory Configuration Files

### ğŸ³ Docker & Runtime Layer

### 1. Dockerfile

```
FROM node:22-alpine

WORKDIR /usr/src/app
RUN apk add --no-cache openssl
COPY package.json package-lock.json ./
RUN npm ci
COPY . .

RUN npx prisma generate
RUN npm run build
RUN ls -la dist

EXPOSE 3000
CMD ["npm", "run", "start:prod"]

```

**Why critical:**

- Node version lock (22-alpine)
- Prisma generate before build
- Build vs runtime separation
- Correct CMD entry point

### 2. docker-compose.yml

**Why critical:**

- Service wiring (API + Postgres + Redis)
- Environment variable injection
- Volume persistence
- Network configuration
- Container naming (important for Prisma)

### 3. .dockerignore

**Why critical:**

- Faster builds
- Avoid broken images

**Must include:**

```
node_modules
dist
.git
.env

```

### ğŸ§  TypeScript / NestJS Core

### 4. tsconfig.json

**Why critical:**

- Prisma 7 compatibility
- Output path correctness
- Module resolution
- Must exclude: ["prisma", "generated"]

### 5. nest-cli.json

**Why critical:**

- Correct build output
- Prevent missing dist/main.js

```json
{
  "compilerOptions": {
    "deleteOutDir": true
  }
}

```

This always deletes root dist folder on build.

### 6. package.json

**Critical scripts:**

```json
{
  "scripts": {
    "build": "nest build",
    "start:prod": "node dist/main.js",
    "prisma:generate": "prisma generate"
  }
}

```

### ğŸ§¬ Prisma 7 Configuration

### 7. prisma.config.ts

**Why critical:** Prisma 7 entry point

```tsx
import { defineConfig } from 'prisma/config';

export default defineConfig({
  schema: 'prisma/schema.prisma',
});

```

### 8. prisma/schema.prisma

**Why critical:** Database contract + client generation

```
generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  // NO url here - Prisma 7 reads from runtime adapter
}

```

<aside>
**ğŸš¨ Prisma 7 RULE:** No DATABASE_URL inside schema. Prisma 7 reads from runtime adapter.

</aside>

### 9. src/prisma/prisma.service.ts

**Why critical:**

- Prisma 7 adapter construction
- App stability
- Lifecycle hooks
- This file always changes with Prisma major versions

### 10. src/prisma/prisma.module.ts

**Why critical:**

- Global Prisma injection
- Must use @Global() decorator
- Provider export

### ğŸŒ Environment Management

### 11. .env

**Required variables:**

```bash
DATABASE_URL=postgresql://user:password@localhost:5432/db_name
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret
REDIS_URL=redis://localhost:6379

```

### 12. src/config/env.validation.ts

**Why critical:** Crash early on bad config

- Zod schema validation
- Required vars enforcement

### 13. src/config/database.config.ts

**Why critical:** Central DB config for future read replicas

### 14. src/config/app.config.ts

**Why critical:** App metadata + environment awareness

### ğŸ— Application Entry

### 15. src/main.ts

**Why critical:**

- App bootstrap
- Global pipes (ValidationPipe)
- Global filters
- Graceful shutdown

## ğŸ§  The Only Correct Prisma 7 Mental Model

```
Prisma Client
      â†“
Driver Adapter (pg, mysql, sqlite, etc.)
      â†“
Actual DB connection

```

**Key Understanding:**

- The standard way to instantiate the client in Prisma 7 is no longer just `new PrismaClient()` or `super()` without parameters
- You **must** pass an options object containing a database driver adapter
- Prisma 7 reads DATABASE_URL at runtime via adapter

## ğŸ” Phase 2: Authentication Implementation

### Phase 2 Roadmap

### 1ï¸âƒ£ Core Auth

- âœ… User registration
- âœ… User login
- âœ… JWT access token (15m)
- âœ… JWT refresh token (7d)
- âœ… HttpOnly refresh cookie

### 2ï¸âƒ£ Security Hardening

- âœ… Account lock after failed attempts
- âœ… Failed login counter reset on success
- âœ… Refresh token rotation
- âœ… Refresh token reuse detection
- âœ… Refresh token stored hashed (SHA-256, not bcrypt)

### 3ï¸âƒ£ Guards & Strategies

- âœ… AccessAuthGuard
- âœ… RefreshAuthGuard
- âœ… JwtStrategy
- âœ… JwtRefreshStrategy
- âœ… cookie-parser integrated in e2e

### 4ï¸âƒ£ Database

- âœ… refreshTokenHash
- âš ï¸ refreshTokenUsedAt (obsolete - should be removed)
- âœ… Prisma integration stable

### 5ï¸âƒ£ E2E Tests

- âœ… Login works
- âœ… Refresh works
- âœ… Refresh reuse fails (after SHA-256 fix)
- âœ… DB cleanup before test

### Password Hashing Flow

```
Registration:
password (plain)
    â†“
hashPassword() [bcrypt]
    â†“
UsersService.createUser()
    â†“
DB

Login:
password (plain)
    â†“
verifyPassword() [bcrypt]
    â†“
allow / deny

```

### Refresh Token Lifecycle

```
Request
    â†“
JwtRefreshGuard
    â†“
JwtRefreshStrategy.validate()
    â†“
Controller method
    â†“
authService.refreshTokens()

```

## ğŸ”¥ Critical Security Lesson: bcrypt vs SHA-256

### The Problem We Discovered

Many auth tutorials use bcrypt for both passwords AND refresh tokens. This appears to work but contains a critical bug.

<aside>
**ğŸ”¥ bcrypt silently truncates input after 72 bytes**

</aside>

This becomes critical when:

- Input is long (JWTs are ~200+ chars)
- Structurally similar at the beginning (JWT header + payload)
- Being compared for rotation detection

### Why This Defeats Reuse Detection

JWTs share the same:

- Header
- Start of payload

So rotation produced tokens that were different, but bcrypt saw **identical truncated input**.

### The Correct Approach

| **Use Case** | **Goal** | **Correct Hash** |
| --- | --- | --- |
| Passwords | Slow down brute force | bcrypt |
| Refresh Tokens | Deterministic equality check | SHA-256 |

**bcrypt is:**

- Slow (intentional)
- Salted
- Non-deterministic
- Input-length limited (72 bytes)

**Refresh token storage requires:**

- Fast
- Deterministic
- Full-length hashing
- No truncation

<aside>
**Key Takeaway:** Different problem â†’ different tool. This is a cryptographic edge case, not a NestJS mistake.

</aside>

## âŒ Why We Don't Use Centralized Routes

Centralized routing looks nice early, but breaks down badly in large systems.

**Problems with a routes.ts file:**

- âŒ Routes drift away from business logic
- âŒ Hard to apply guards, interceptors, pipes
- âŒ Massive merge conflicts
- âŒ Poor module isolation
- âŒ RBAC becomes messy

NestJS intentionally avoids this pattern. Controllers should be co-located with their business logic.

## ğŸ“ Common Troubleshooting

### TypeScript Issues

```bash
# Restart TypeScript server (VS Code)
# Cmd + Shift + P â†’ TypeScript: Restart TS Server

# Clear Jest cache
npx jest --clearCache

# Regenerate Prisma client
npx prisma generate

```

### dist Folder Not Generating

Check `tsconfig.json` carefully:

- Verify `outDir` is set correctly
- Verify `rootDir` is set correctly
- Check `exclude` array doesn't exclude `src`
- Ensure `nest-cli.json` has `deleteOutDir: true`

### Prisma Connection Issues

```bash
# Verify DATABASE_URL in container
docker exec -it nest_api env | grep DATABASE_URL

# Check Prisma adapter is installed
npm list @prisma/adapter-pg

# Regenerate client
npx prisma generate

# ğŸš€ 2026 Developer Command Center: Tech Stack & Workflow

This document outlines the professional Agentic AI development environment Iâ€™ve built for orchestrating modular, enterprise-grade applications.

---

## ğŸ› ï¸ Tech Stack Breakdown

| Category | Technology | Purpose in my Workflow |
| :--- | :--- | :--- |
| **Languages** | TypeScript, JavaScript, PHP | Enables high-speed, type-safe development across both Node.js and PHP ecosystems. |
| **Frameworks** | **NestJS & Laravel** | A hybrid powerhouse: **NestJS** for scalable, modular microservices and **Laravel** for robust, feature-rich backends and rapid API development. |
| **Data Layer** | **PostgreSQL (via Prisma)** | Using **Prisma ORM** as the "Single Source of Truth." This allows my AI agents to parse the `schema.prisma` file for automated migrations and instant type-safe queries. |
| **Environment** | **Docker & Dev Containers** | Eliminates "environment drift" by running the entire AI-driven dev environment in isolated containers, ensuring 100% consistency from local to production. |
| **Agentic Core** | **Aider (v0.86.2) & Cline** | My "Heavy Lifters." These agents perform repository-wide refactoring, autonomous debugging, and automated test-driven development (TDD). |
| **Local AI** | **Ollama** | Running **Qwen2.5-Coder** locally for zero-cost, private code-completion, and routine scripting to optimize API token usage. |
| **High-Tier AI** | **Claude 3.7 / GPT-5.2** | Subscribed flagship models that provide high-level strategic thinking for complex architectural decisions and deep logic debugging. |

---

## ğŸ¤– Strategic Workflow Philosophy

* **Architect over Coder:** I focus on defining the "Definition of Done" and architectural constraints, while Agentic AI handles the implementation.
* **Schema-First Development:** Using Prisma and strict TypeScript types to provide AI agents with the necessary context to prevent hallucinations.
* **Environment Isolation:** Developing exclusively inside Docker Dev Containers to maintain a clean host machine and reproducible builds.
* **Hybrid Intelligence:** Seamlessly switching between local models (Ollama) for privacy/speed and high-tier models (Claude/GPT) for complex reasoning.

---

> **"In 2026, the best developers don't just write code; they orchestrate agents to build systems."**
